name: Build StMicDriver (Simplified)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup NuGet
        uses: nuget/setup-nuget@v1
        
      - name: Install SDK/WDK using Chocolatey
        shell: powershell
        run: |
          Write-Host "Installing SDK/WDK via Chocolatey..."
          choco install windows-sdk-10-version-2004-all -y --no-progress
          choco install windowsdriverkit10 -y --no-progress --ignore-checksums
          Write-Host "SDK/WDK installation completed"

      - name: Resolve SDK/WDK paths
        shell: powershell
        run: |
          $kits = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows Kits\Installed Roots" -ErrorAction SilentlyContinue).KitsRoot10
          if (!$kits) { $kits = "${env:ProgramFiles(x86)}\Windows Kits\10" }
          $includeRoot = Join-Path $kits "Include"
          $libRoot = Join-Path $kits "Lib"
          Write-Host "SDK Include root: $includeRoot"
          Write-Host "SDK Lib root: $libRoot"
          if (!(Test-Path $includeRoot) -or !(Test-Path $libRoot)) {
            throw "Windows SDK roots not found. Include: $includeRoot ; Lib: $libRoot"
          }
          $includeVersions = Get-ChildItem $includeRoot -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Select-Object -ExpandProperty Name
          $libVersions = Get-ChildItem $libRoot -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Select-Object -ExpandProperty Name
          $versions = $includeVersions | Where-Object { $libVersions -contains $_ } | Sort-Object -Descending
          if (!$versions -or $versions.Count -eq 0) {
            throw "No Windows SDK versions found under Include and Lib."
          }
          $ver = $null
          foreach ($name in $versions) {
            $portcls = Join-Path $kits "Include\$name\km\portcls.h"
            $lib = Join-Path $kits "Lib\$name\km\x64\BufferOverflowFastFailK.lib"
            if ((Test-Path $portcls) -and (Test-Path $lib)) {
              $ver = $name
              break
            }
          }
          if (!$ver) {
            throw "No SDK/WDK version found with portcls.h and BufferOverflowFastFailK.lib"
          }
          "SDK_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append
          "WindowsSdkDir=$kits\" | Out-File -FilePath $env:GITHUB_ENV -Append
          "DDK_INC_PATH=$kits\Include\$ver\km;$kits\Include\$ver\shared;$kits\Include\$ver\um" | Out-File -FilePath $env:GITHUB_ENV -Append
          "DDK_LIB_PATH=$kits\Lib\$ver\km\x64\" | Out-File -FilePath $env:GITHUB_ENV -Append
          "WindowsSDKVersion=$ver\" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using SDK/WDK version: $ver"
      
      - name: List MSBuild and check environment
        shell: powershell
        run: |
          Write-Host "Checking MSBuild..."
          msbuild -version
          Write-Host "`nChecking WDK..."
          Get-ChildItem "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions\WDK" -ErrorAction SilentlyContinue | Select-Object -First 10
          Write-Host "`nChecking Windows Kits roots..."
          Get-ChildItem "$env:ProgramFiles(x86)\Windows Kits\10" -ErrorAction SilentlyContinue | Select-Object -First 10
      
      - name: Build APO
        shell: powershell
        run: |
          Write-Host "Building VirtualMic APO..."
          msbuild StMicDriver\Source\Apo\VirtualMicApo.vcxproj /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$env:SDK_VERSION /p:WindowsSDKVersion="$env:SDK_VERSION\" /p:WindowsSdkDir="$env:WindowsSdkDir" /v:minimal /m
      
      - name: Stage APO for driver package
        shell: powershell
        run: |
          $apo = Get-ChildItem -Path StMicDriver -Recurse -Filter VirtualMicApo.dll | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $apo) { throw "VirtualMicApo.dll not found" }
          $dest = "StMicDriver\\Source\\Main\\x64\\Release"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          $target = Join-Path $dest "VirtualMicApo.dll"
          $targetPath = (Resolve-Path $target -ErrorAction SilentlyContinue).Path
          if ($targetPath -and ($apo.FullName -ieq $targetPath)) {
            Write-Host "APO already staged at $targetPath"
          } else {
            Copy-Item $apo.FullName -Destination $dest -Force
            Write-Host "Staged APO: $($apo.FullName) -> $dest"
          }

      - name: Build Driver
        shell: powershell
        run: |
          cd StMicDriver
          Write-Host "Building StMicDriver..."
          msbuild SimpleAudioSample.sln /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$env:SDK_VERSION /p:WindowsSDKVersion="$env:SDK_VERSION\" /p:WindowsSdkDir="$env:WindowsSdkDir" /p:RunInfVerif=false /p:DisableInfVerif=true /p:InfVerif=false /p:EnableInfVerif=false /v:minimal /m
      
      - name: Check Build Output
        shell: powershell
        run: |
          Write-Host "Checking build output..."
          Write-Host "Searching for build artifacts..."
          Get-ChildItem -Path . -Recurse -Include *.sys,*.inf,*.cat | Select-Object FullName, Length
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: StMicDriver-Output
          path: |
            **/*.sys
            **/*.inf
            **/*.cat
            **/*.cer
            **/package/**/*
          if-no-files-found: warn
