name: Build StMicDriver (Simplified)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup NuGet
        uses: nuget/setup-nuget@v1
        
      - name: Install SDK/WDK using Chocolatey
        shell: powershell
        run: |
          Write-Host "Installing SDK/WDK via Chocolatey..."
          choco install windows-sdk-10-version-2004-all -y --no-progress
          choco install windowsdriverkit10 -y --no-progress --ignore-checksums
          Write-Host "SDK/WDK installation completed"

      - name: Resolve SDK/WDK paths
        shell: powershell
        run: |
          $kits = "${env:ProgramFiles(x86)}\Windows Kits\10"
          $includeRoot = Join-Path $kits "Include"
          $libRoot = Join-Path $kits "Lib"
          $includeVersions = Get-ChildItem $includeRoot -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' }
          $libVersions = Get-ChildItem $libRoot -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' }
          $versions = $includeVersions.Name | Where-Object { $libVersions.Name -contains $_ } | Sort-Object -Descending
          if (!$versions -or $versions.Count -eq 0) {
            Write-Error "No Windows SDK versions found under $includeRoot and $libRoot"
            exit 1
          }
          $ver = $null
          foreach ($v in $versions) {
            $name = $v
            $portcls = Join-Path $kits "Include\$name\km\portcls.h"
            $lib = Join-Path $kits "Lib\$name\km\x64\BufferOverflowFastFailK.lib"
            if ((Test-Path $portcls) -and (Test-Path $lib)) {
              $ver = $name
              break
            }
          }
          if (!$ver) {
            Write-Error "No SDK/WDK version found with portcls.h and BufferOverflowFastFailK.lib"
            exit 1
          }
          "SDK_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append
          "WindowsSdkDir=$kits\" | Out-File -FilePath $env:GITHUB_ENV -Append
          "DDK_INC_PATH=$kits\Include\$ver\km;$kits\Include\$ver\shared;$kits\Include\$ver\um" | Out-File -FilePath $env:GITHUB_ENV -Append
          "DDK_LIB_PATH=$kits\Lib\$ver\km\x64" | Out-File -FilePath $env:GITHUB_ENV -Append
          "WindowsSDKVersion=$ver\" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Using SDK/WDK version: $ver"
      
      - name: List MSBuild and check environment
        shell: powershell
        run: |
          Write-Host "Checking MSBuild..."
          msbuild -version
          Write-Host "`nChecking WDK..."
          Get-ChildItem "C:\Program Files*" -Recurse -Filter "wdk*" -ErrorAction SilentlyContinue | Select-Object -First 5
      
      - name: Build Driver
        shell: powershell
        run: |
          cd StMicDriver
          Write-Host "Building StMicDriver..."
          msbuild SimpleAudioSample.sln /p:Configuration=Release /p:Platform=x64 /p:WindowsSdkDir="$env:WindowsSdkDir" /p:RunInfVerif=false /v:minimal /m
        continue-on-error: true
      
      - name: Check Build Output
        shell: powershell
        run: |
          Write-Host "Checking build output..."
          Write-Host "Searching for build artifacts..."
          Get-ChildItem -Path . -Recurse -Include *.sys,*.inf,*.cat | Select-Object FullName, Length
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: StMicDriver-Output
          path: |
            **/*.sys
            **/*.inf
            **/*.cat
            **/*.cer
            **/package/**/*
          if-no-files-found: warn
