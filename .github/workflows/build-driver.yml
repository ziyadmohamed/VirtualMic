name: Build StMicDriver (Simplified)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.3
      
      - name: Setup NuGet
        uses: nuget/setup-nuget@v1
        
      - name: Install WDK using Chocolatey
        shell: powershell
        run: |
          Write-Host "Installing WDK via Chocolatey..."
          choco install windows-sdk-10-version-2004-all -y --no-progress
          choco install windowsdriverkit10 -y --no-progress --ignore-checksums
          Write-Host "WDK installation completed"
        continue-on-error: true
      
      - name: List MSBuild and check environment
        shell: powershell
        run: |
          Write-Host "Checking MSBuild..."
          msbuild -version
          Write-Host "`nChecking WDK..."
          Get-ChildItem "C:\Program Files*" -Recurse -Filter "wdk*" -ErrorAction SilentlyContinue | Select-Object -First 5
      
      - name: Build Driver
        shell: powershell
        run: |
          cd StMicDriver
          Write-Host "Building StMicDriver..."
          msbuild SimpleAudioSample.sln /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=10.0.19041.0 /v:minimal /m
        continue-on-error: true
      
      - name: Check Build Output
        shell: powershell
        run: |
          Write-Host "Checking build output..."
          Write-Host "Searching for build artifacts..."
          Get-ChildItem -Path . -Recurse -Include *.sys,*.inf,*.cat | Select-Object FullName, Length
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: StMicDriver-Output
          path: |
            **/*.sys
            **/*.inf
            **/*.cat
            **/*.cer
            **/package/**/*
          if-no-files-found: warn
